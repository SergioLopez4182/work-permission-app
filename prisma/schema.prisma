// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model Client {
  id              Int              @id @default(autoincrement())
  name            String
  users           User[]
  shoppingCenters ShoppingCenter[]
  createdAt       DateTime         @default(now()) @map("created_at")
  updatedAt       DateTime         @updatedAt @map("updated_at")

  @@map("clients")
}

model User {
  id              Int                  @id @default(autoincrement())
  name            String
  lastName        String               @map("last_name")
  email           String               @unique
  password        String
  client          Client               @relation(fields: [clientId], references: [id], onDelete: Cascade)
  clientId        Int                  @map("client_id")
  permissions     Permission[]
  shoppingCenters UserShoppingCenter[]
  retailSpaces    UserRetailSpace[]
  createdAt       DateTime             @default(now()) @map("created_at")
  updatedAt       DateTime             @updatedAt @map("updated_at")

  @@map("users")
}

model ShoppingCenter {
  id           Int                  @id @default(autoincrement())
  name         String
  client       Client               @relation(fields: [clientId], references: [id], onDelete: Cascade)
  clientId     Int                  @map("client_id")
  users        UserShoppingCenter[]
  retailSpaces RetailSpace[]
  createdAt    DateTime             @default(now()) @map("created_at")
  updatedAt    DateTime             @updatedAt @map("updated_at")

  @@map("shopping_centers")
}

model UserShoppingCenter {
  user   User @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId Int  @map("user_id")

  shoppingCenter   ShoppingCenter @relation(fields: [shoppingCenterId], references: [id], onDelete: Cascade)
  shoppingCenterId Int            @map("shopping_center_id")

  assignedAt DateTime @default(now()) @map("assigned_at")
  isActive   Boolean  @default(true)

  @@id([userId, shoppingCenterId])
  @@map("user_shopping_centers")
}

model RetailSpace {
  id               Int               @id @default(autoincrement())
  name             String
  shoppingCenter   ShoppingCenter    @relation(fields: [shoppingCenterId], references: [id], onDelete: Cascade)
  shoppingCenterId Int               @map("shopping_center_id")
  floor            String
  users            UserRetailSpace[]
  permissions      Permission[]
  createdAt        DateTime          @default(now()) @map("created_at")
  updatedAt        DateTime          @updatedAt @map("updated_at")

  @@map("retail_space")
}

model UserRetailSpace {
  user   User @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId Int  @map("user_id")

  retailSpace   RetailSpace @relation(fields: [retailSpaceId], references: [id], onDelete: Cascade)
  retailSpaceId Int         @map("retail_space_id")

  assignedAt DateTime @default(now()) @map("assigned_at")
  isActive   Boolean  @default(true)

  @@id([userId, retailSpaceId])
  @@map("user_retail_spaces")
}

enum DomainObject {
  PERMISSION @map("permission")
  ORDER      @map("order")
  CONTRACT   @map("contract")

  @@map("domain_object")
}

model Status {
  id           Int          @id @default(autoincrement())
  name         String
  label        String
  description  String?
  domainObject DomainObject
  permissions  Permission[]
  createdAt    DateTime     @default(now()) @map("created_at")
  updatedAt    DateTime     @updatedAt @map("updated_at")

  @@unique([name, domainObject])
  @@map("statuses")
}

model Type {
  id           Int          @id @default(autoincrement())
  name         String
  label        String
  description  String?
  domainObject DomainObject
  permissions  Permission[]
  createdAt    DateTime     @default(now()) @map("created_at")
  updatedAt    DateTime     @updatedAt @map("updated_at")

  @@unique([name, domainObject])
  @@map("types")
}

model Permission {
  id                 Int          @id @default(autoincrement())
  retailSpace        RetailSpace  @relation(fields: [retailSpaceId], references: [id])
  retailSpaceId      Int          @map("retail_space_id")
  user               User         @relation(fields: [userId], references: [id])
  userId             Int          @map("user_id")
  status             Status       @relation(fields: [statusId], references: [id])
  statusId           Int          @map("status_id")
  type               Type         @relation(fields: [typeId], references: [id])
  typeId             Int          @map("type_id")
  startDate          DateTime     @map("start_date")
  endDate            DateTime     @map("end_date")
  startHour          DateTime     @map("start_hour")
  endHour            DateTime     @map("end_hour")
  description        String
  workerName         String       @map("worker_name")
  workerPhone        String       @map("worker_phone")
  workerCompanions   Int          @default(1) @map("worker_companions")
  workerVehiclePlate String?      @map("worker_vehicle_plate")
  workerFiles        WorkerFile[]
  createdAt          DateTime     @default(now()) @map("created_at")
  updatedAt          DateTime     @updatedAt @map("updated_at")

  @@index([retailSpaceId])
  @@index([userId])
  @@index([statusId])
  @@index([typeId])
  @@index([startDate])
  @@map("permissions")
}

model WorkerFile {
  id           Int        @id @default(autoincrement())
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  permissionId Int        @map("permission_id")
  fileName     String     @map("file_name")
  mimeType     String     @map("mime_type")
  data         Bytes
  createdAt    DateTime   @default(now()) @map("created_at")
  updatedAt    DateTime   @updatedAt @map("updated_at")

  @@map("worker_files")
}
